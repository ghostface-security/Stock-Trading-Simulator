{% extends "base.html" %}

{% block title %}Stock Market{% endblock %}

{% block content %}
<div class="dashboard-container">
    <aside class="sidebar">
        <h2>Welcome, {{ user.username }}</h2>
        <a href="{{ url_for('banking_dashboard') }}">Banking Dashboard</a>
        <a href="{{ url_for('stock_dashboard') }}">Stock Market</a>
        <a href="{{ url_for('logout') }}">Log Out</a>
    </aside>

    <main class="main-content">
        <div class="dashboard-card">
            <h2>Account Summary</h2>
            <div class="info-block">
                <p>Available Funds:</p>
                <span id="available-funds">${{ "{:,.2f}".format(user_wallet.balance) }}</span>
            </div>
        </div>

        <div class="dashboard-card">
            <h2>Marketplace</h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Ticker</th>
                        <th>Name</th>
                        <th>Price</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="marketplace-table-body">
                    {% for symbol in stock_names.keys() %}
                    <tr data-stock-symbol="{{ symbol }}">
                        <td>{{ symbol }}</td>
                        <td>{{ stock_names[symbol] }}</td>
                        <td id="stock-price-{{ symbol }}">${{ "{:,.2f}".format(market_prices[symbol]) }}</td>
                        <td>
                            <form action="{{ url_for('buy_stock') }}" method="post" style="display:inline;">
                                <input type="hidden" name="symbol" value="{{ symbol }}">
                                <input type="number" name="quantity" placeholder="Qty" min="1" required style="width: 60px;">
                                <button type="submit" class="button-primary">Buy</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="dashboard-card">
            <h2>My Portfolio</h2>
            {% if portfolio %}
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Ticker</th>
                        <th>Shares</th>
                        <th>Cost Basis</th>
                        <th>Current Value</th>
                        <th>P/L %</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="portfolio-table-body">
                    {% for item in portfolio %}
                    <tr data-stock-symbol="{{ item.symbol }}">
                        <td>{{ item.symbol }}</td>
                        <td>{{ item.quantity }}</td>
                        <td>${{ "{:,.2f}".format(item.cost_basis) }}</td>
                        <td id="portfolio-value-{{ item.symbol }}"></td>
                        <td id="portfolio-pl-{{ item.symbol }}"></td>
                        <td>
                            <form action="{{ url_for('sell_stock') }}" method="post" style="display:inline;">
                                <input type="hidden" name="symbol" value="{{ item.symbol }}">
                                <input type="number" name="quantity" placeholder="Qty" min="1" max="{{ item.quantity }}" required style="width: 60px;">
                                <button type="submit" class="button-primary">Sell</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p style="text-align: center; color: #6c757d;">Your portfolio is currently empty. Buy some stocks to get started!</p>
            {% endif %}
        </div>
    </main>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Helper function to format currency
        const formatCurrency = (amount) => {
            return '$' + parseFloat(amount).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        };

        const fetchAndUpdateStocks = async () => {
            try {
                // Fetch the current prices from the server
                const response = await fetch('/get_stock_prices');
                const prices = await response.json();

                // Update the marketplace table
                const marketplaceRows = document.querySelectorAll('#marketplace-table-body tr');
                marketplaceRows.forEach(row => {
                    const symbol = row.getAttribute('data-stock-symbol');
                    const priceElement = document.getElementById(`stock-price-${symbol}`);
                    if (priceElement && prices[symbol] !== undefined) {
                        priceElement.textContent = formatCurrency(prices[symbol]);
                    }
                });

                // Update the portfolio table
                const portfolioItems = document.querySelectorAll('#portfolio-table-body tr');
                portfolioItems.forEach(item => {
                    const symbol = item.getAttribute('data-stock-symbol');
                    const stockPrice = prices[symbol];

                    if (stockPrice !== undefined) {
                        const quantityText = item.querySelector('td:nth-child(2)');
                        const quantity = parseInt(quantityText.textContent);

                        const costBasisElement = item.querySelector('td:nth-child(3)');
                        const costBasisText = costBasisElement.textContent;
                        const costBasis = parseFloat(costBasisText.replace(/[^0-9.-]+/g, ''));
                        
                        const currentValue = quantity * stockPrice;
                        const profitLoss = currentValue - (quantity * costBasis);
                        const profitLossPercentage = (profitLoss / (quantity * costBasis)) * 100;
                        
                        const valueElement = document.getElementById(`portfolio-value-${symbol}`);
                        const plElement = document.getElementById(`portfolio-pl-${symbol}`);

                        if (valueElement) {
                            valueElement.textContent = formatCurrency(currentValue);
                        }
                        if (plElement) {
                            plElement.textContent = `${profitLossPercentage.toFixed(2)}%`;
                            plElement.style.color = profitLoss >= 0 ? 'green' : 'red';
                        }
                    }
                });
            } catch (error) {
                console.error("Failed to fetch stock prices:", error);
            }
        };

        // Add a new route to fetch stock prices
        const newPriceRoute = async () => {
            try {
                const response = await fetch('{{ url_for("get_stock_prices") }}');
                const prices = await response.json();
                
                const marketplaceRows = document.querySelectorAll('#marketplace-table-body tr');
                marketplaceRows.forEach(row => {
                    const symbol = row.getAttribute('data-stock-symbol');
                    const priceElement = row.querySelector(`#stock-price-${symbol}`);
                    if (priceElement && prices[symbol] !== undefined) {
                        priceElement.textContent = formatCurrency(prices[symbol]);
                    }
                });

                const portfolioItems = document.querySelectorAll('#portfolio-table-body tr');
                portfolioItems.forEach(item => {
                    const symbol = item.getAttribute('data-stock-symbol');
                    const stockPrice = prices[symbol];
                    if (stockPrice !== undefined) {
                        const quantity = parseInt(item.querySelector('td:nth-child(2)').textContent);
                        const costBasis = parseFloat(item.querySelector('td:nth-child(3)').textContent.replace(/[^0-9.-]+/g, ''));
                        const currentValue = quantity * stockPrice;
                        const profitLoss = currentValue - (quantity * costBasis);
                        const profitLossPercentage = (profitLoss / (quantity * costBasis)) * 100;
                        
                        document.getElementById(`portfolio-value-${symbol}`).textContent = formatCurrency(currentValue);
                        const plElement = document.getElementById(`portfolio-pl-${symbol}`);
                        plElement.textContent = `${profitLossPercentage.toFixed(2)}%`;
                        plElement.style.color = profitLoss >= 0 ? 'green' : 'red';
                    }
                });
            } catch (error) {
                console.error("Error fetching stock prices:", error);
            }
        };

        // Call the function on page load
        newPriceRoute();

        // Set an interval to refresh stock prices every 15 seconds
        setInterval(newPriceRoute, 15000);
    });
</script>
{% endblock %}
